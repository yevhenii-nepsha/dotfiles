#!/bin/bash
# =============================================================================
# Git Commit Message Validator
# =============================================================================
# Enforces commit message standards across all repositories
# Auto-installed via dotfiles setup

commit_file="$1"
commit_msg=$(cat "$commit_file")

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# =============================================================================
# Validation Rules
# =============================================================================

# 1. Check for AI tool mentions (CRITICAL)
# Blocked: claude (non-filename), generated, assisted, openai, gpt, copilot, ü§ñ
# Note: "AI" is too general and allowed (appears in main, email, filenames, etc.)

# Replace CLAUDE.md with placeholder to avoid false positive
temp_msg=$(echo "$commit_msg" | sed 's/CLAUDE\.md/FILENAME/g')

# Check for specific AI tool mentions
if echo "$temp_msg" | grep -iE "(^| )(claude|generated|assisted|openai|gpt|copilot)( |$|[.,!?])|ü§ñ" > /dev/null; then
    echo -e "${RED}‚ùå COMMIT REJECTED: Contains AI tool mentions${NC}"
    echo "Blocked: claude, generated, assisted, openai, gpt, copilot, ü§ñ"
    echo "Allowed: CLAUDE.md (filename)"
    echo "Message: '$commit_msg'"
    exit 1
fi

# 2. Check first line length (‚â§72 chars - GitHub truncate limit)
first_line=$(echo "$commit_msg" | head -n1)
if [ ${#first_line} -gt 72 ]; then
    echo -e "${RED}‚ùå COMMIT REJECTED: First line too long (${#first_line}/72)${NC}"
    echo "First line: '$first_line'"
    echo "Shorten to ‚â§72 characters (GitHub displays fully up to 72)"
    exit 1
fi

# 3. Check for empty first line
if [ -z "$(echo "$first_line" | xargs)" ]; then
    echo -e "${RED}‚ùå COMMIT REJECTED: Empty commit message${NC}"
    exit 1
fi

# 4. Check for vague messages
if echo "$first_line" | grep -E "^(fix|update|change|modify|stuff|things|work)(\s|$)" > /dev/null; then
    echo -e "${RED}‚ùå COMMIT REJECTED: Too vague${NC}"
    echo "Be specific: 'Fix what?' 'Update what?'"
    echo "Current: '$first_line'"
    exit 1
fi

# 5. Check for proper capitalization
if ! echo "$first_line" | grep -E "^[A-Z]" > /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: First word should be capitalized${NC}"
    echo "Current: '$first_line'"
fi

# 6. Suggest imperative mood if not detected
if ! echo "$first_line" | grep -E "^(Add|Fix|Update|Remove|Refactor|Implement|Create|Delete|Improve|Optimize|Configure|Setup|Install|Deploy|Test|Document|Clean|Rename|Move|Merge|Revert)" > /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  SUGGESTION: Consider using imperative mood${NC}"
    echo "Start with: Add, Fix, Update, Remove, Refactor, Implement, etc."
    echo "Current: '$first_line'"
fi

# =============================================================================
# Success
# =============================================================================
echo -e "${GREEN}‚úÖ Commit message validated${NC}"
echo "Message: '$first_line'"
exit 0