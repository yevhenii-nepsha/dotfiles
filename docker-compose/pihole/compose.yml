name: "pihole"

services:
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    hostname: pihole
    ports:
      - "53:53/tcp"      # DNS TCP
      - "53:53/udp"      # DNS UDP
      - "8053:80/tcp"    # Web UI (using 8053 to avoid conflict with port 80)
    environment:
      # Timezone for logs and stats
      TZ: ${TIMEZONE}

      # Web admin password (FTLCONF_ prefix for new Pi-hole versions)
      FTLCONF_webserver_api_password: ${PIHOLE_PASSWORD}

      # Upstream DNS servers (semicolon-separated)
      FTLCONF_dns_upstreams: ${UPSTREAM_DNS_1};${UPSTREAM_DNS_2}

      # DNS listening mode (required for Docker bridge network)
      FTLCONF_dns_listeningMode: all

      # Performance tuning
      FTLCONF_dns_bogusPriv: "true"        # Never forward reverse lookups for private ranges
      FTLCONF_dns_dnssec: "false"          # DNSSEC validation (disable if issues)
      FTLCONF_dns_revServer_enabled: "false"  # Enable if you want reverse DNS lookups

    volumes:
      # Persistent data for settings and block lists
      - ${PIHOLE_DATA_PATH}/etc-pihole:/etc/pihole
      - ${PIHOLE_DATA_PATH}/etc-dnsmasq.d:/etc/dnsmasq.d

    security_opt:
      - no-new-privileges:true

    cap_add:
      # Required capabilities for DNS operations
      - NET_ADMIN

    networks:
      - pihole-network

    healthcheck:
      test: ["CMD", "dig", "+short", "+tries=1", "+time=2", "@127.0.0.1", "pi.hole"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  pihole-network:
    driver: bridge
