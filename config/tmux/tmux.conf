# Enable 256-color and true-color (24-bit) support in tmux
set -g default-terminal "tmux-256color" # Modern terminal type with 256-color support
set -ga terminal-overrides ",*256col*:Tc" # Override to enable true-color for compatible terminals
set -ga terminal-overrides ",*:RGB" # Enable RGB color support
set -as terminal-features ',*:hyperlinks'

# General Settings
set -g set-clipboard on # Use system clipboard
set -g mouse on # Enable mouse support
set -g status-interval 5 # Update status bar every 5 seconds (optimized)
set -g detach-on-destroy off # Don't exit from tmux when closing a session
set -g history-limit 50000 # Increase scrollback buffer size (50k lines)
set -g repeat-time 600 # Increase repeat time for repeated commands
set -g display-time 1500 # Display messages for 1.5 seconds
set -g escape-time 0 # No delay for escape key press
set -g focus-events on # Enable focus events for better integration
set-option -g allow-rename off # Don't allow programs to rename windows
set-window-option -g automatic-rename off # Don't auto-rename windows based on running command

# Shift + Enter sends Enter key
bind-key -n S-Enter send-keys Enter

# Prefix Key Configuration
unbind C-b # Unbind the default prefix key
set -g prefix C-s # Set prefix to Ctrl+s
bind C-s send-prefix # Allow sending Ctrl+s to applications

# Refresh tmux config with r
unbind r
bind r source-file ~/.config/tmux/tmux.conf \; display-message "âœ… Config reloaded!"

# Window & Pane Management
# Split horizontally in CWD with \
unbind %
bind \\ split-window -h -c "#{pane_current_path}"

# Split vertically in CWD with -
unbind \"
bind - split-window -v -c "#{pane_current_path}"

# New window with custom name (popup input)
bind c display-popup -E -w 20% -h 3 "~/.dotfiles/scripts/tmux-window-create.sh"

# Session navigation shortcuts
bind s display-popup -E -w 25% -h 8 "~/.dotfiles/scripts/tmux-session-selector.sh"
bind N display-popup -E -w 15% -h 3 "~/.dotfiles/scripts/tmux-session-create.sh"
bind D display-popup -E -w 25% -h 8 "~/.dotfiles/scripts/tmux-session-delete.sh"
bind w choose-window

# URL picker - extract and open URLs from current pane
bind u display-popup -E -w 50% -h 12 "~/.dotfiles/scripts/tmux-url-picker.sh"

# Window management shortcuts
bind -r '<' swap-window -d -t -1 # Move window left
bind -r '>' swap-window -d -t +1 # Move window right
bind Tab last-window # Quick switch to last window
bind Space next-layout # Cycle through layouts
bind , command-prompt "rename-window '%%'" # Rename window
bind '$' command-prompt "rename-session '%%'" # Rename session

# Pane Resizing (vim-style)
bind -r j resize-pane -D 5
bind -r k resize-pane -U 5
bind -r l resize-pane -R 5
bind -r h resize-pane -L 5
bind -r m resize-pane -Z # Use m key to toggle pane zoom

# Center current pane with margins (useful for wide monitors)
bind C split-window -h -p 15 "clear; cat" \; select-pane -L \; split-window -h -b -p 18 "clear; cat" \; select-pane -R

# Note: Vim-aware pane navigation is provided by vim-tmux-navigator plugin
# See plugin configuration section for Ctrl+h/j/k/l navigation

# Vi Mode Configuration
# Enable vi mode for navigation and copying
set-window-option -g mode-keys vi

# Copy mode key bindings
bind-key -T copy-mode-vi 'v' send -X begin-selection # Start selection with v

# Cross-platform clipboard support with OSC 52 for SSH
# OSC 52 allows copying to local clipboard when tmux runs on remote server via SSH
if-shell "uname | grep -q Darwin" \
    "bind -T copy-mode-vi 'y' send-keys -X copy-pipe-and-cancel 'pbcopy'" \
    "bind -T copy-mode-vi 'y' send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard || wl-copy'"

# Enable OSC 52 clipboard for remote sessions (SSH)
set -as terminal-features ',*:clipboard'

bind -T copy-mode-vi 'C-v' send -X rectangle-toggle # Toggle rectangle selection
bind -T copy-mode-vi 'Enter' send -X copy-pipe-and-cancel # Copy on Enter
bind -T copy-mode-vi 'Escape' send -X cancel # Exit copy mode with Escape

# Mouse integration improvements
unbind -T copy-mode-vi MouseDragEnd1Pane # Don't exit copy mode when dragging

# Additional copy mode navigation (vim-style)
bind -T copy-mode-vi 'C-d' send -X halfpage-down
bind -T copy-mode-vi 'C-u' send -X halfpage-up
bind -T copy-mode-vi 'C-b' send -X page-up
bind -T copy-mode-vi 'C-f' send -X page-down
bind -T copy-mode-vi '/' command-prompt -p "search down" "send -X search-forward \"%%%\""
bind -T copy-mode-vi '?' command-prompt -p "search up" "send -X search-backward \"%%%\""

# Window & Pane Indexing
set -g base-index 1 # Start windows at 1, not 0
set -g pane-base-index 1 # Start panes at 1, not 0
set -g renumber-windows on # Automatically renumber windows when one is closed

# Window activity monitoring
setw -g monitor-activity on # Monitor for activity in windows
set -g visual-activity off # Don't show visual notification for activity
set -g bell-action other # Ring bell for activity in other windows

# Advanced Pane Management
bind b break-pane -d # Break pane into new window
bind J command-prompt -p "join pane from:" "join-pane -s '%%'" # Join pane from window
bind C-j display-panes \; command-prompt -p "pane to join:" "join-pane -t '%%'" # Join current pane to target

# Synchronize panes toggle
bind S set-window-option synchronize-panes\; display-message "ðŸ”„ synchronize-panes is now #{?pane_synchronized,on,off}"

# Clear history and screen (prefix + C-k to avoid conflict with vim navigation)
bind C-k send-keys 'C-l' \; clear-history

# Popup support (tmux 3.2+)
# Note: requires lazygit and fzf to be installed
bind g display-popup -E -w 80% -h 80% "lazygit" # Lazygit in popup
bind t display-popup -E -w 80% -h 80% # General popup terminal

# Quick session switcher with preview (requires fzf)
# Use prefix+s for the built-in session selector

# Kill shortcuts (progression: pane â†’ window â†’ session)
bind x confirm-before -p "ðŸ—‘ï¸  kill-pane #P? (y/n)" kill-pane
bind X confirm-before -p "âš ï¸  kill-window #W? (y/n)" kill-window
bind K confirm-before -p "ðŸ’£ kill-session #S? THIS WILL CLOSE EVERYTHING! (y/n)" kill-session

# Plugin Configuration
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'christoomey/vim-tmux-navigator' # Navigate between nvim and tmux
set -g @plugin 'tmux-plugins/tmux-resurrect' # Save and restore tmux sessions
set -g @plugin 'tmux-plugins/tmux-continuum' # Automatic session saving and restoration
set -g @plugin 'tmux-plugins/tmux-open' # Open URLs and files from tmux

# Resurrect & Continuum Configuration
set -g @resurrect-strategy-nvim 'session' # Save neovim sessions
set -g @resurrect-capture-pane-contents 'on' # Save pane contents
set -g @resurrect-save-shell-history 'off' # Disabled: causes duplicate prompts on restore
set -g @continuum-restore 'on' # Auto-restore sessions on tmux start
set -g @continuum-save-interval '15' # Auto-save every 15 minutes

# Additional programs to restore (besides default: vim, nvim, etc)
# Using arrow syntax to restore claude with --continue flag
set -g @resurrect-processes 'ssh psql mysql sqlite3 "~python" "~ipython" "~claude->claude --continue"'

# Save directory location for sessions
set -g @resurrect-dir '~/.config/tmux/resurrect'

# ============================================================================
# STATUS BAR CONFIGURATION
# ============================================================================

# Status bar position (top of screen)
set -g status-position top

# Align window list to the left
set -g status-justify left

# Status bar refresh interval (set in General Settings above)

# Status bar lengths
set -g status-left-length 40
set -g status-right-length 80

# Window status separator
set -g window-status-separator ""

# ============================================================================
# MOONFLY COLORS
# ============================================================================
# Based on: https://github.com/bluz71/vim-moonfly-colors/blob/master/extras/moonfly.tmux

# Pane borders
set -g pane-border-style 'fg=#1c1c1c'
set -g pane-active-border-style 'fg=#80a0ff'

# Status line colors
set -g status-style 'bg=#080808,fg=#bdbdbd'

# Message colors
set -g message-style 'bg=#1c1c1c,fg=#80a0ff,bold'
set -g message-command-style 'bg=#1c1c1c,fg=#80a0ff'

# Window status colors
setw -g window-status-style 'fg=#808080'
setw -g window-status-current-style 'fg=#80a0ff,bold'
setw -g window-status-activity-style 'fg=#e65e72'
setw -g window-status-bell-style 'fg=#ff5454'

# Mode colors (copy mode, etc)
setw -g mode-style 'bg=#1c1c1c,fg=#80a0ff'

# Clock color
setw -g clock-mode-colour '#80a0ff'

# Status bar format
set -g status-left "#[fg=#80a0ff,bold][#S] "
set -g status-right "#[fg=#808080]%d %b #[fg=#bdbdbd]%H:%M "
set -g window-status-format "#[fg=#808080] #I:#W "
set -g window-status-current-format "#[fg=#80a0ff,bold] #I:#W "

# Popup colors
set -g popup-border-style 'fg=#80a0ff,bg=#080808'
set -g popup-style 'bg=#080808,fg=#bdbdbd'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
